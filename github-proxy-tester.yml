name: Test and Publish SOCKS5 Proxies

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤© UTC 00:00ï¼Œå³åŒ—äº¬æ—¶é—´ 08:00
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  test-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pysocks
      
      - name: Run SOCKS5 Proxy Tester
        run: python3 test_proxies.py
      
      - name: Check fast proxies availability
        id: check_proxies
        run: |
          if [ -f working_proxies_fast.txt ] && [ -s working_proxies_fast.txt ]; then
            echo "has_fast_proxies=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ°å¿«é€Ÿä»£ç†ï¼Œå°†åˆ›å»º Release"
          else
            echo "has_fast_proxies=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æ²¡æœ‰å¿«é€Ÿä»£ç†ï¼Œè·³è¿‡ Release åˆ›å»º"
          fi
      
      - name: Generate date
        id: date
        if: steps.check_proxies.outputs.has_fast_proxies == 'true'
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
      
      - name: Count proxies
        id: count
        if: steps.check_proxies.outputs.has_fast_proxies == 'true'
        run: |
          total_count=$(wc -l < working_proxies.txt 2>/dev/null || echo 0)
          fast_count=$(wc -l < working_proxies_fast.txt 2>/dev/null || echo 0)
          echo "total=$total_count" >> $GITHUB_OUTPUT
          echo "fast=$fast_count" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        if: steps.check_proxies.outputs.has_fast_proxies == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: proxy-${{ steps.date.outputs.datetime }}
          name: "SOCKS5 Proxies - ${{ steps.date.outputs.date }}"
          body: |
            ## ğŸ¯ å¯ç”¨çš„ SOCKS5 ä»£ç†åˆ—è¡¨
            
            ğŸ“… æµ‹è¯•æ—¶é—´: ${{ steps.date.outputs.date }}
            âœ… å¯ç”¨ä»£ç†: ${{ steps.count.outputs.total }} ä¸ª
            âš¡ å¿«é€Ÿä»£ç†: ${{ steps.count.outputs.fast }} ä¸ª
            
            ### ğŸ“¥ ä¸‹è½½åœ°å€
            - [working_proxies.txt](https://github.com/${{ github.repository }}/releases/latest/download/working_proxies.txt)
            - [working_proxies_fast.txt](https://github.com/${{ github.repository }}/releases/latest/download/working_proxies_fast.txt)
            - [working_proxies_stats.txt](https://github.com/${{ github.repository }}/releases/latest/download/working_proxies_stats.txt)
            
            ### ğŸ“– è¯´æ˜
            - ç®€å•æ ¼å¼: `IP:Port`
            - å¸¦è®¤è¯: `username:password@IP:Port`
            - å¯ç›´æ¥ç”¨äº SOCKS5 å®¢æˆ·ç«¯
            - `working_proxies.txt`: æ‰€æœ‰å¯ç”¨ä»£ç†
            - `working_proxies_fast.txt`: å¿«é€Ÿä»£ç†ï¼ˆå·²è¿‡æ»¤æ…¢é€Ÿï¼‰
            - `working_proxies_stats.txt`: è¯¦ç»†æµ‹è¯•ç»Ÿè®¡
          files: |
            working_proxies.txt
            working_proxies_fast.txt
            working_proxies_stats.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
      
      - name: Clean up old releases
        if: steps.check_proxies.outputs.has_fast_proxies == 'true'
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 5        # âœ… ä¿ç•™æœ€è¿‘ 5 ä¸ªç‰ˆæœ¬
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
