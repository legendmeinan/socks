name: Test and Publish SOCKS5 Proxies

on:
  schedule:
    # æ¯å¤©è¿è¡Œä¸€æ¬¡ (UTC æ—¶é—´ 00:00ï¼Œå³åŒ—äº¬æ—¶é—´ 08:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»º release å’Œä¸Šä¼ èµ„æº

env:
  MAX_PROXIES: 200  # æœ€å¤§è¯»å–ä»£ç†æ•°é‡

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šå¹¶å‘æµ‹è¯•ä»£ç†å¯ç”¨æ€§ï¼ˆ10ä¸ªworkerï¼‰
  test-availability:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker_id: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
      fail-fast: false  # å³ä½¿æŸä¸ªworkerå¤±è´¥ï¼Œå…¶ä»–ç»§ç»­è¿è¡Œ
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install requests pysocks

    - name: Test proxy availability (Worker ${{ matrix.worker_id }})
      run: |
        python test_availability.py ${{ matrix.worker_id }} 10 ${{ env.MAX_PROXIES }}
      env:
        PYTHONUNBUFFERED: 1  # å®æ—¶è¾“å‡ºæ—¥å¿—

    - name: Upload available proxies
      uses: actions/upload-artifact@v4
      with:
        name: available-proxies-${{ matrix.worker_id }}
        path: available_proxies_${{ matrix.worker_id }}.txt
        retention-days: 1

  # ç¬¬äºŒé˜¶æ®µï¼šåˆå¹¶å¹¶æµ‹è¯•é€Ÿåº¦
  test-speed:
    needs: test-availability
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install requests pysocks

    - name: Download all available proxies
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Merge available proxies
      run: |
        echo "ğŸ”„ åˆå¹¶æ‰€æœ‰å¯ç”¨ä»£ç†..."
        cat artifacts/available-proxies-*/available_proxies_*.txt > all_available_proxies.txt
        # å»é‡
        sort -u all_available_proxies.txt > merged_proxies.txt
        COUNT=$(wc -l < merged_proxies.txt)
        echo "âœ… åˆå¹¶å®Œæˆï¼Œå…± $COUNT ä¸ªå¯ç”¨ä»£ç†"
        cat merged_proxies.txt

    - name: Test proxy speed
      run: |
        python test_speed.py
      env:
        PYTHONUNBUFFERED: 1

    - name: Display results
      run: |
        echo "=========================================="
        echo "æµ‹è¯•ç»“æœç»Ÿè®¡"
        echo "=========================================="
        echo "æœ€å¤§è¯»å–ä»£ç†æ•°: ${{ env.MAX_PROXIES }}"
        echo "æ‰€æœ‰å¯ç”¨ä»£ç†: $(wc -l < working_proxies.txt)"
        echo "å¿«é€Ÿä»£ç†: $(wc -l < working_proxies_fast.txt)"
        echo "=========================================="
        
        echo "å‰10ä¸ªæœ€å¿«çš„ä»£ç†:"
        head -15 working_proxies_fast.txt | tail -10

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: final-results
        path: |
          working_proxies.txt
          working_proxies_fast.txt
          working_proxies_stats.txt
        retention-days: 7

  # ç¬¬ä¸‰é˜¶æ®µï¼šå‘å¸ƒ Release
  publish-release:
    needs: test-speed
    runs-on: ubuntu-latest
    
    steps:
    - name: Download final results
      uses: actions/download-artifact@v4
      with:
        name: final-results

    - name: Generate release date
      id: date
      run: |
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "datetime=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

    - name: Read stats for release body
      id: stats
      run: |
        AVAILABLE=$(wc -l < working_proxies.txt)
        FAST=$(wc -l < working_proxies_fast.txt)
        echo "available=$AVAILABLE" >> $GITHUB_OUTPUT
        echo "fast=$FAST" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: proxy-${{ steps.date.outputs.datetime }}
        release_name: Working Proxies - ${{ steps.date.outputs.date }}
        body: |
          ## ğŸ¯ å¯ç”¨çš„ SOCKS5 ä»£ç†åˆ—è¡¨
          
          ğŸ“… æµ‹è¯•æ—¶é—´: ${{ steps.date.outputs.date }}
          ğŸ“Š æµ‹è¯•æ ·æœ¬: æœ€å¤š ${{ env.MAX_PROXIES }} ä¸ªä»£ç†
          âœ… å¯ç”¨ä»£ç†: ${{ steps.stats.outputs.available }} ä¸ª
          ğŸš€ å¿«é€Ÿä»£ç†: ${{ steps.stats.outputs.fast }} ä¸ª (å·²æŒ‰å»¶è¿Ÿæ’åº)
          
          ### ğŸ“¥ ä¸‹è½½æ–‡ä»¶
          - **working_proxies.txt** - æ‰€æœ‰å¯ç”¨çš„ä»£ç†
          - **working_proxies_fast.txt** - å¿«é€Ÿä»£ç† (å»¶è¿Ÿâ‰¤3s, é€Ÿåº¦â‰¥10KB/s)
          - **working_proxies_stats.txt** - è¯¦ç»†æµ‹è¯•ç»Ÿè®¡
          
          ### ä½¿ç”¨æ–¹æ³•
          ```bash
          # ä¸‹è½½æ‰€æœ‰å¯ç”¨ä»£ç†
          wget https://github.com/${{ github.repository }}/releases/latest/download/working_proxies.txt
          
          # ä¸‹è½½å¿«é€Ÿä»£ç†ï¼ˆæ¨èï¼‰
          wget https://github.com/${{ github.repository }}/releases/latest/download/working_proxies_fast.txt
          ```
          
          ### æ ¼å¼è¯´æ˜
          - ç®€å•æ ¼å¼: `IP:Port`
          - å¸¦è®¤è¯: `username:password@IP:Port`
          - å®Œæ•´æ ¼å¼: `socks5://IP:Port` æˆ– `socks5://username:password@IP:Port`
          
          å¿«é€Ÿä»£ç†åˆ—è¡¨å¸¦æœ‰é€Ÿåº¦æ³¨é‡Š: `ä»£ç†åœ°å€  # å»¶è¿Ÿ(s) | é€Ÿåº¦(KB/s)`
        draft: false
        prerelease: false

    - name: Upload working proxies
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./working_proxies.txt
        asset_name: working_proxies.txt
        asset_content_type: text/plain

    - name: Upload fast proxies
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./working_proxies_fast.txt
        asset_name: working_proxies_fast.txt
        asset_content_type: text/plain
    
    - name: Upload stats
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./working_proxies_stats.txt
        asset_name: working_proxies_stats.txt
        asset_content_type: text/plain

    - name: Clean up old releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      with:
        keep_latest: 7  # ä¿ç•™æœ€è¿‘ 7 ä¸ª release
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
