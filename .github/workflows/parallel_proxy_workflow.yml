name: Test and Publish SOCKS5 Proxies (Parallel)

on:
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤© UTC 02:00
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  # ==================== é˜¶æ®µ 1: åˆ†ç‰‡æµ‹è¯•å¯ç”¨æ€§ ====================
  test-availability-1:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      has_results: ${{ steps.check.outputs.has_results }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pysocks
      
      - name: Test proxies (Shard 1/3)
        run: |
          python3 test_proxies_shard.py --shard 1 --total-shards 3 --stage availability
      
      - name: Check results
        id: check
        run: |
          if [ -f working_proxies_shard1.txt ] && [ -s working_proxies_shard1.txt ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload results
        if: steps.check.outputs.has_results == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: availability-shard-1
          path: working_proxies_shard1.txt
          retention-days: 1

  test-availability-2:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      has_results: ${{ steps.check.outputs.has_results }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pysocks
      
      - name: Test proxies (Shard 2/3)
        run: |
          python3 test_proxies_shard.py --shard 2 --total-shards 3 --stage availability
      
      - name: Check results
        id: check
        run: |
          if [ -f working_proxies_shard2.txt ] && [ -s working_proxies_shard2.txt ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload results
        if: steps.check.outputs.has_results == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: availability-shard-2
          path: working_proxies_shard2.txt
          retention-days: 1

  test-availability-3:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      has_results: ${{ steps.check.outputs.has_results }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pysocks
      
      - name: Test proxies (Shard 3/3)
        run: |
          python3 test_proxies_shard.py --shard 3 --total-shards 3 --stage availability
      
      - name: Check results
        id: check
        run: |
          if [ -f working_proxies_shard3.txt ] && [ -s working_proxies_shard3.txt ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload results
        if: steps.check.outputs.has_results == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: availability-shard-3
          path: working_proxies_shard3.txt
          retention-days: 1

  # ==================== é˜¶æ®µ 2: åˆå¹¶å¯ç”¨ä»£ç†å¹¶åˆ†ç‰‡æµ‹é€Ÿ ====================
  merge-and-prepare-speed-test:
    needs: [test-availability-1, test-availability-2, test-availability-3]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has_proxies: ${{ steps.split.outputs.has_proxies }}
    steps:
      - name: Download all availability results
        uses: actions/download-artifact@v4
        with:
          pattern: availability-shard-*
          merge-multiple: true
      
      - name: Merge and split for speed test
        id: split
        run: |
          # åˆå¹¶æ‰€æœ‰å¯ç”¨ä»£ç†
          cat working_proxies_shard*.txt 2>/dev/null | sort -u > all_working_proxies.txt || touch all_working_proxies.txt
          
          total_proxies=$(wc -l < all_working_proxies.txt)
          echo "âœ… å¯ç”¨ä»£ç†æ€»æ•°: $total_proxies"
          
          if [ "$total_proxies" -eq 0 ]; then
            echo "has_proxies=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_proxies=true" >> $GITHUB_OUTPUT
          
          # åˆ†æˆ3ä»½ç”¨äºé€Ÿåº¦æµ‹è¯•
          proxies_per_shard=$(( (total_proxies + 2) / 3 ))
          
          split -l $proxies_per_shard all_working_proxies.txt speed_shard_
          
          # é‡å‘½ååˆ†ç‰‡æ–‡ä»¶
          i=1
          for file in speed_shard_*; do
            mv "$file" "speed_test_shard${i}.txt"
            count=$(wc -l < "speed_test_shard${i}.txt")
            echo "åˆ†ç‰‡ $i: $count ä¸ªä»£ç†"
            i=$((i + 1))
          done
      
      - name: Upload speed test shards
        if: steps.split.outputs.has_proxies == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: speed-test-shards
          path: speed_test_shard*.txt
          retention-days: 1

  # ==================== é˜¶æ®µ 3: å¹¶è¡Œé€Ÿåº¦æµ‹è¯• ====================
  test-speed-1:
    needs: merge-and-prepare-speed-test
    if: needs.merge-and-prepare-speed-test.outputs.has_proxies == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      has_results: ${{ steps.check.outputs.has_results }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pysocks
      
      - name: Download speed test shard
        uses: actions/download-artifact@v4
        with:
          name: speed-test-shards
      
      - name: Test speed (Shard 1/3)
        run: |
          if [ -f speed_test_shard1.txt ]; then
            python3 test_proxies_shard.py --input speed_test_shard1.txt --output fast_proxies_shard1.txt --stage speed
          fi
      
      - name: Check results
        id: check
        run: |
          if [ -f fast_proxies_shard1.txt ] && [ -s fast_proxies_shard1.txt ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload results
        if: steps.check.outputs.has_results == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: speed-shard-1
          path: fast_proxies_shard1.txt
          retention-days: 1

  test-speed-2:
    needs: merge-and-prepare-speed-test
    if: needs.merge-and-prepare-speed-test.outputs.has_proxies == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      has_results: ${{ steps.check.outputs.has_results }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pysocks
      
      - name: Download speed test shard
        uses: actions/download-artifact@v4
        with:
          name: speed-test-shards
      
      - name: Test speed (Shard 2/3)
        run: |
          if [ -f speed_test_shard2.txt ]; then
            python3 test_proxies_shard.py --input speed_test_shard2.txt --output fast_proxies_shard2.txt --stage speed
          fi
      
      - name: Check results
        id: check
        run: |
          if [ -f fast_proxies_shard2.txt ] && [ -s fast_proxies_shard2.txt ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload results
        if: steps.check.outputs.has_results == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: speed-shard-2
          path: fast_proxies_shard2.txt
          retention-days: 1

  test-speed-3:
    needs: merge-and-prepare-speed-test
    if: needs.merge-and-prepare-speed-test.outputs.has_proxies == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      has_results: ${{ steps.check.outputs.has_results }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pysocks
      
      - name: Download speed test shard
        uses: actions/download-artifact@v4
        with:
          name: speed-test-shards
      
      - name: Test speed (Shard 3/3)
        run: |
          if [ -f speed_test_shard3.txt ]; then
            python3 test_proxies_shard.py --input speed_test_shard3.txt --output fast_proxies_shard3.txt --stage speed
          fi
      
      - name: Check results
        id: check
        run: |
          if [ -f fast_proxies_shard3.txt ] && [ -s fast_proxies_shard3.txt ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload results
        if: steps.check.outputs.has_results == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: speed-shard-3
          path: fast_proxies_shard3.txt
          retention-days: 1

  # ==================== é˜¶æ®µ 4: åˆå¹¶ç»“æœå¹¶å‘å¸ƒ ====================
  merge-and-publish:
    needs: [test-speed-1, test-speed-2, test-speed-3]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: "*-shard-*"
          merge-multiple: true
        continue-on-error: true
      
      - name: Merge all results
        id: merge
        run: |
          # åˆå¹¶æ‰€æœ‰å¯ç”¨ä»£ç†
          cat working_proxies_shard*.txt 2>/dev/null | sort -u > working_proxies.txt || touch working_proxies.txt
          
          # åˆå¹¶æ‰€æœ‰å¿«é€Ÿä»£ç†
          cat fast_proxies_shard*.txt 2>/dev/null | sort -u > working_proxies_fast.txt || touch working_proxies_fast.txt
          
          total_count=$(wc -l < working_proxies.txt 2>/dev/null || echo 0)
          fast_count=$(wc -l < working_proxies_fast.txt 2>/dev/null || echo 0)
          
          echo "total=$total_count" >> $GITHUB_OUTPUT
          echo "fast=$fast_count" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ç»Ÿè®¡ç»“æœ:"
          echo "   âœ… å¯ç”¨ä»£ç†: $total_count ä¸ª"
          echo "   âš¡ å¿«é€Ÿä»£ç†: $fast_count ä¸ª"
          
          if [ "$fast_count" -ge 3 ]; then
            echo "has_fast_proxies=true" >> $GITHUB_OUTPUT
            echo "âœ… å¿«é€Ÿä»£ç†æ•°é‡å……è¶³ (â‰¥3)ï¼Œå°†åˆ›å»º Release"
          else
            echo "has_fast_proxies=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ å¿«é€Ÿä»£ç†ä¸è¶³ ($fast_count < 3)ï¼Œè·³è¿‡ Release åˆ›å»º"
            echo "âŒ å·¥ä½œæµå°†åœæ­¢ï¼Œä¸ä¼šå‘å¸ƒä»»ä½•å†…å®¹"
          fi
          
          # ç”Ÿæˆç»Ÿè®¡æ–‡ä»¶ï¼ˆä»…åœ¨æœ‰å¿«é€Ÿä»£ç†æ—¶ï¼‰
          if [ "$fast_count" -gt 0 ]; then
            cat > working_proxies_stats.txt << EOF
================================================================================
SOCKS5 ä»£ç†æµ‹è¯•ç»Ÿè®¡æŠ¥å‘Š (å¹¶è¡Œæµ‹è¯•)
================================================================================

æµ‹è¯•æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
æµ‹è¯•æ–¹å¼: 3å¹¶è¡Œ (å¯ç”¨æ€§) + 3å¹¶è¡Œ (é€Ÿåº¦)

âœ… å¯ç”¨ä»£ç†: $total_count ä¸ª
âš¡ å¿«é€Ÿä»£ç†: $fast_count ä¸ª

================================================================================
EOF
          fi_count"
      
      - name: Generate date
        id: date
        if: steps.merge.outputs.has_fast_proxies == 'true'
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        if: steps.merge.outputs.has_fast_proxies == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: proxy-${{ steps.date.outputs.datetime }}
          name: "SOCKS5 Proxies - ${{ steps.date.outputs.date }}"
          body: |
            ## ğŸ¯ å¯ç”¨çš„ SOCKS5 ä»£ç†åˆ—è¡¨ (å¹¶è¡Œæµ‹è¯•)
            
            ğŸ“… æµ‹è¯•æ—¶é—´: ${{ steps.date.outputs.date }}
            âœ… å¯ç”¨ä»£ç†: ${{ steps.merge.outputs.total }} ä¸ª
            âš¡ å¿«é€Ÿä»£ç†: ${{ steps.merge.outputs.fast }} ä¸ª
            ğŸš€ æµ‹è¯•æ–¹å¼: 3å¹¶è¡Œå¯ç”¨æ€§æµ‹è¯• + 3å¹¶è¡Œé€Ÿåº¦æµ‹è¯•
            
            ### ğŸ“¥ ä¸‹è½½åœ°å€
            - [working_proxies.txt](https://github.com/${{ github.repository }}/releases/latest/download/working_proxies.txt) - æ‰€æœ‰å¯ç”¨ä»£ç†
            - [working_proxies_fast.txt](https://github.com/${{ github.repository }}/releases/latest/download/working_proxies_fast.txt) - å¿«é€Ÿä»£ç†
            - [working_proxies_stats.txt](https://github.com/${{ github.repository }}/releases/latest/download/working_proxies_stats.txt) - ç»Ÿè®¡ä¿¡æ¯
            
            ### ğŸ“– æ ¼å¼è¯´æ˜
            - ç®€å•æ ¼å¼: `IP:Port`
            - å¸¦è®¤è¯: `username:password@IP:Port`
            - å¯ç›´æ¥ç”¨äº SOCKS5 å®¢æˆ·ç«¯
          files: |
            working_proxies.txt
            working_proxies_fast.txt
            working_proxies_stats.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
      
      - name: Clean up old releases
        if: steps.merge.outputs.has_fast_proxies == 'true'
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 5
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
