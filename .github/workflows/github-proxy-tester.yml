name: Test and Publish SOCKS5 Proxies

on:
  schedule:
    # æ¯å¤©è¿è¡Œä¸€æ¬¡ (UTC æ—¶é—´ 00:00ï¼Œå³åŒ—äº¬æ—¶é—´ 08:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write     
  
jobs:
  test-proxies:
    runs-on: ubuntu-latest
    

  
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install requests pysocks

    - name: Test proxies
      run: |
        python test_proxies.py

    - name: Generate release date
      id: date
      run: |
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "datetime=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
      with:
        tag_name: proxy-${{ steps.date.outputs.datetime }}
        release_name: Working Proxies - ${{ steps.date.outputs.date }}
        body: |
          ## ğŸ¯ å¯ç”¨çš„ SOCKS5 ä»£ç†åˆ—è¡¨
          
          ğŸ“… æµ‹è¯•æ—¶é—´: ${{ steps.date.outputs.date }}
          âœ… å¯ç”¨ä»£ç†: $(wc -l < working_proxies.txt) ä¸ª
          ğŸš€ å¿«é€Ÿä»£ç†: $(wc -l < working_proxies_fast.txt) ä¸ª (å·²æŒ‰å»¶è¿Ÿæ’åº)
          
          ### ğŸ“¥ ä¸‹è½½æ–‡ä»¶
          - **working_proxies.txt** - æ‰€æœ‰å¯ç”¨çš„ä»£ç†
          - **working_proxies_fast.txt** - å¿«é€Ÿä»£ç† (å»¶è¿Ÿâ‰¤3s, é€Ÿåº¦â‰¥10KB/s)
          - **working_proxies_stats.txt** - è¯¦ç»†æµ‹è¯•ç»Ÿè®¡
          
          ### ä½¿ç”¨æ–¹æ³•
          ```bash
          # ä¸‹è½½æ‰€æœ‰å¯ç”¨ä»£ç†
          wget https://github.com/${{ github.repository }}/releases/latest/download/working_proxies.txt
          
          # ä¸‹è½½å¿«é€Ÿä»£ç†ï¼ˆæ¨èï¼‰
          wget https://github.com/${{ github.repository }}/releases/latest/download/working_proxies_fast.txt
          ```
          
          ### æ ¼å¼è¯´æ˜
          - ç®€å•æ ¼å¼: `IP:Port`
          - å¸¦è®¤è¯: `username:password@IP:Port`
          - å®Œæ•´æ ¼å¼: `socks5://IP:Port` æˆ– `socks5://username:password@IP:Port`
          
          å¿«é€Ÿä»£ç†åˆ—è¡¨å¸¦æœ‰é€Ÿåº¦æ³¨é‡Š: `ä»£ç†åœ°å€  # å»¶è¿Ÿ(s) | é€Ÿåº¦(KB/s)`
        draft: false
        prerelease: false

    - name: Upload working proxies
      uses: actions/upload-release-asset@v2
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./working_proxies.txt
        asset_name: working_proxies.txt
        asset_content_type: text/plain

    - name: Clean up old releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      with:
        keep_latest: 7  # ä¿ç•™æœ€è¿‘ 7 ä¸ª release
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
