name: Test and Publish SOCKS5 Proxies

on:
  schedule:
    - cron: "0 0 * * *"  # 每天 UTC 00:00，即北京时间 08:00
  workflow_dispatch:       # 支持手动触发

permissions:
  contents: write

jobs:
  test-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pysocks
      
      - name: Run SOCKS5 Proxy Tester
        run: python3 test_proxies.py
      
      - name: Check fast proxies availability
        id: check_proxies
        run: |
          if [ -f working_proxies_fast.txt ] && [ -s working_proxies_fast.txt ]; then
            echo "has_fast_proxies=true" >> $GITHUB_OUTPUT
            echo "✅ 找到快速代理，将创建 Release"
          else
            echo "has_fast_proxies=false" >> $GITHUB_OUTPUT
            echo "⚠️ 没有快速代理，跳过 Release 创建"
          fi
      
      - name: Generate date
        id: date
        if: steps.check_proxies.outputs.has_fast_proxies == 'true'
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
      
      - name: Count proxies
        id: count
        if: steps.check_proxies.outputs.has_fast_proxies == 'true'
        run: |
          total_count=$(wc -l < working_proxies.txt 2>/dev/null || echo 0)
          fast_count=$(wc -l < working_proxies_fast.txt 2>/dev/null || echo 0)
          echo "total=$total_count" >> $GITHUB_OUTPUT
          echo "fast=$fast_count" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        if: steps.check_proxies.outputs.has_fast_proxies == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: proxy-${{ steps.date.outputs.datetime }}
          name: "SOCKS5 Proxies - ${{ steps.date.outputs.date }}"
          body: |
            ## 🎯 可用的 SOCKS5 代理列表
            
            📅 测试时间: ${{ steps.date.outputs.date }}
            ✅ 可用代理: ${{ steps.count.outputs.total }} 个
            ⚡ 快速代理: ${{ steps.count.outputs.fast }} 个
            
            ### 📥 下载地址
            - [working_proxies.txt](https://github.com/${{ github.repository }}/releases/latest/download/working_proxies.txt)
            - [working_proxies_fast.txt](https://github.com/${{ github.repository }}/releases/latest/download/working_proxies_fast.txt)
            - [working_proxies_stats.txt](https://github.com/${{ github.repository }}/releases/latest/download/working_proxies_stats.txt)
            
            ### 📖 说明
            - 简单格式: `IP:Port`
            - 带认证: `username:password@IP:Port`
            - 可直接用于 SOCKS5 客户端
            - `working_proxies.txt`: 所有可用代理
            - `working_proxies_fast.txt`: 快速代理（已过滤慢速）
            - `working_proxies_stats.txt`: 详细测试统计
          files: |
            working_proxies.txt
            working_proxies_fast.txt
            working_proxies_stats.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
      
      - name: Clean up old releases
        if: steps.check_proxies.outputs.has_fast_proxies == 'true'
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 5        # ✅ 保留最近 5 个版本
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
